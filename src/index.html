<!doctype html>
<html lang="en" x-bind:class="{ 'dark': darkMode }">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <meta name="theme-color" content="#ffffff" id="theme-color" />
    <title>Kite</title>
    <link rel="manifest" href="%VITE_STATIC_PATH%/manifest.json" />
    <link
      rel="icon"
      type="image/svg+xml"
      href="%VITE_STATIC_PATH%/svg/kite.svg"
    />
    <link
      rel="apple-touch-icon"
      href="%VITE_STATIC_PATH%/apple-touch-icon.png"
    />
    <link rel="stylesheet" href="./styles/index.css" />
    <script type="module" src="./main.mjs"></script>
    <link
      rel="alternate"
      :href="currentCategory === 'OnThisDay' ? 'https://en.wikipedia.org/w/api.php?action=featuredfeed&feed=onthisday' : currentCategory.toLowerCase() + '.xml'"
      type="application/rss+xml"
      :title="'Kagi News - ' + currentCategory"
    />
  </head>

  <body
    class="dark:bg-dark-bg dark:text-dark-text min-h-screen bg-white text-black"
    x-data="Object.assign(kiteApp(), sourceOverlay())"
    x-bind:class="[
            $store.fontSize.current === 'extra-small' ? 'text-xs' : 
            $store.fontSize.current === 'small' ? 'text-sm' : 
            $store.fontSize.current === 'large' ? 'text-lg' : 'text-base',
            $store.mobileUI.categoryHeaderPosition === 'top' ? 'pt-14 md:pt-0' : ''
        ]"
    @touchstart="
            touchStartX = $event.changedTouches[0].screenX; 
            touchStartY = $event.changedTouches[0].screenY;
            
            // Check if touch started on a scrollable element
            const target = $event.target;
            const scrollableParent = findScrollableParent(target);
            touchStartedOnScrollable = scrollableParent && 
                                      (scrollableParent.scrollWidth > scrollableParent.clientWidth);
        "
    @touchend="
            if (touchStartedOnScrollable) {
                // Don't change category if touch started on a scrollable element
                return;
            }
            
            // Check if the touch started on or within the category tabs
            const categoryTabs = document.querySelector('.category-tabs');
            if (categoryTabs && (categoryTabs.contains($event.target) || categoryTabs === $event.target)) {
                return;
            }
            
            // Check if category swiping is disabled in experimental settings
            if ($store.experimental.disableCategorySwipe) {
                return;
            }
            
            touchEndX = $event.changedTouches[0].screenX;
            touchEndY = $event.changedTouches[0].screenY;
            const deltaX = touchStartX - touchEndX;
            const deltaY = touchStartY - touchEndY;

            // Require horizontal movement to be at least twice the vertical movement
            // This makes accidental swipes less likely
            if (Math.abs(deltaX) < Math.abs(deltaY) * 2) {
                return;
            }

            if (Math.abs(deltaX) > 50) {
                const categories = Array.from($store.categories.enabled);
                const currentIndex = categories.indexOf(currentCategory);
                if (deltaX > 0 && currentIndex < categories.length - 1) {
                    currentCategory = categories[currentIndex + 1];
                    changeCategory();
                } else if (deltaX < 0 && currentIndex > 0) {
                    currentCategory = categories[currentIndex - 1];
                    changeCategory();
                }

                // Scroll the selected category into view
                $nextTick(() => {
                    const selectedTab = document.querySelector('.category-tab.active');
                    if (selectedTab) {
                        selectedTab.scrollIntoView({ behavior: 'smooth', block: 'nearest', inline: 'center' });
                    }
                });
            }
        "
  >
    <!-- Wikipedia Popup -->
    <div
      id="wikipedia-popup"
      class="fixed z-[200] hidden overflow-y-auto bg-white p-4 shadow-xl dark:bg-gray-800"
      style="max-width: 600px; max-height: 80vh"
    >
      <button
        id="wikipedia-popup-close"
        onclick="document.getElementById('wikipedia-popup').style.display='none'"
        class="absolute top-2 right-2 text-gray-500 hover:text-gray-700 dark:text-gray-400 dark:hover:text-gray-200"
      >
        <svg
          xmlns="http://www.w3.org/2000/svg"
          class="h-6 w-6"
          fill="none"
          viewBox="0 0 24 24"
          stroke="currentColor"
        >
          <path
            stroke-linecap="round"
            stroke-linejoin="round"
            stroke-width="2"
            d="M6 18L18 6M6 6l12 12"
          />
        </svg>
      </button>
      <div id="wikipedia-popup-layout" class="flex h-full flex-col">
        <img
          id="wikipedia-popup-image"
          class="mb-4 w-full rounded object-contain"
          style="
            max-height: 200px;
            max-width: 100%;
            height: auto;
            display: none;
          "
          alt="Article image"
        />
        <div class="flex-1">
          <div id="wikipedia-popup-content"></div>
        </div>
      </div>
    </div>
    <!-- Splash Screen -->
    <div
      x-show="initialLoading"
      x-transition
      class="dark:bg-dark-bg fixed inset-0 z-50 flex items-center justify-center bg-white"
    >
      <div class="text-center">
        <div x-data="{ imageLoaded: false }" class="mx-auto mb-4 h-24 w-24">
          <img
            :src="$store.theme.current === 'dark' ? '%VITE_STATIC_PATH%/svg/kite_dark.svg' : '%VITE_STATIC_PATH%/svg/kite.svg'"
            alt="Kite Logo"
            class="h-full w-full animate-bounce"
            x-show="imageLoaded"
            @load="imageLoaded = true"
            style="display: none"
          />
        </div>
        <h1
          class="dark:text-dark-text mb-2 flex items-center text-2xl font-bold text-gray-800"
        >
          <span x-text="$t('app.title')"></span>
          <span
            class="mt-0.5 ml-2 rounded-lg bg-yellow-200 px-2 py-0.5 text-xs font-medium text-black"
            x-text="$t('app.beta')"
          ></span>
        </h1>
        <p
          class="text-xl text-gray-600 dark:text-gray-400"
          x-text="$t('app.motto')"
        ></p>
        <p
          x-text="loadingProgress > 20 ? loadingProgress + '%' : ''"
          class="mt-4 min-h-[1.5rem] text-sm text-gray-500 dark:text-gray-400"
        ></p>
      </div>
    </div>

    <!-- About Screen -->
    <div
      x-show="showIntro && !getArticleIdFromUrl()"
      x-cloak
      class="fixed inset-0 z-50 flex items-center justify-center overflow-y-auto bg-white dark:bg-gray-900"
    >
      <div class="mx-auto h-full w-full max-w-3xl p-4 sm:p-8">
        <div class="rounded-lg bg-white p-8 dark:bg-gray-800">
          <div class="mb-8 flex items-start justify-between">
            <div class="w-full">
              <h1 class="mb-2 text-3xl font-bold text-gray-900 dark:text-white">
                Kite
              </h1>
              <p
                class="text-gray-600 dark:text-gray-300"
                x-text="$t('about.subtitle')"
              ></p>
            </div>
          </div>

          <div class="space-y-6 text-gray-700 dark:text-gray-300">
            <section>
              <h2
                class="mb-3 text-xl font-semibold text-gray-900 dark:text-white"
              >
                <span x-html="$t('about.why.title')"></span>
              </h2>
              <p class="mb-4" x-html="$t('about.why.description')"></p>
            </section>
            <section>
              <h2
                class="mb-3 text-xl font-semibold text-gray-900 dark:text-white"
              >
                <span x-html="$t('about.approach.title')"></span>
              </h2>
              <p
                class="mb-4 text-gray-700 dark:text-gray-300"
                x-html="$t('about.approach.description1')"
              ></p>
              <p
                class="mb-4 text-gray-700 dark:text-gray-300"
                x-html="$t('about.approach.description2')"
              ></p>
              <p
                class="mb-4 text-gray-700 dark:text-gray-300"
                x-html="$t('about.approach.description3')"
              ></p>
            </section>

            <section>
              <h2
                class="mb-3 text-xl font-semibold text-gray-900 dark:text-white"
              >
                <span x-html="$t('about.principles.title')"></span>
              </h2>
              <ul class="space-y-2">
                <template
                  x-for="(principle, index) in $t('about.principles.list')"
                  :key="index"
                >
                  <li>• <span x-text="principle"></span></li>
                </template>
              </ul>
            </section>
            <section>
              <h2
                class="mb-3 text-xl font-semibold text-gray-900 dark:text-white"
              >
                <span x-html="$t('about.customization.title')"></span>
              </h2>
              <p x-html="$t('about.customization.description')"></p>
            </section>
            <section>
              <h2
                class="mb-3 text-xl font-semibold text-gray-900 dark:text-white"
              >
                <span x-html="$t('about.contact.title')"></span>
              </h2>
              <p x-html="$t('about.contact.description')"></p>
            </section>

            <div class="mt-8 flex justify-center">
              <button
                @click="closeIntro()"
                class="focus:ring-opacity-75 rounded-lg bg-black px-6 py-3 font-semibold text-white transition-colors duration-200 ease-in-out hover:bg-gray-800 focus:ring-2 focus:ring-gray-400 focus:outline-none"
              >
                <span x-html="$t('about.understand.button')"></span>
              </button>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Main Content -->
    <main
      x-show="!initialLoading && !showIntro"
      x-cloak
      class="pb-[60px] md:pb-0"
    >
      <div class="container mx-auto max-w-[732px] px-4 py-8">
        <header class="mb-1 flex items-center justify-between">
          <div class="flex items-center">
            <img
              :src="$store.theme.current === 'dark' || ($store.theme.current === 'system' && window.matchMedia('(prefers-color-scheme: dark)').matches) ? '%VITE_STATIC_PATH%/svg/kite_dark.svg' : '%VITE_STATIC_PATH%/svg/kite.svg'"
              alt="Kite News Logo"
              class="mr-2 h-8 w-8"
              @click="$event.target.classList.add('kite-logo'); setTimeout(() => $event.target.classList.remove('kite-logo'), 3000)"
            />
            <a
              href="javascript:void(0)"
              @click="window.location.href = window.location.pathname"
              class="flex items-center"
            >
              <h1 class="text-xl font-bold text-gray-800 dark:text-gray-200">
                Kite
              </h1>
            </a>
          </div>
          <div
            class="cursor-pointer text-gray-600 dark:text-gray-400"
            x-data="{ dateClickCount: 0 }"
            @click="dateClickCount = (dateClickCount + 1) % 5"
            x-text="dateClickCount === 0 ? new Intl.DateTimeFormat($store.language.current === 'default' ? navigator.language : $store.language.current, { weekday: 'long', month: 'long', day: 'numeric' }).format(new Date())                                                                                                                                                                        
                             : dateClickCount === 1 ? getLastUpdated()                                                                                                                                                                                                                                                                                           
                             : dateClickCount === 2 ? $t('stats.newsToday').replace('{count}', totalReadCount)
                             : dateClickCount === 3 ? $t('stats.storiesRead').replace('{count}', totalStoriesRead)
                             : $t('stats.weekDay').replace('{week}', Math.ceil((new Date() - new Date(new Date().getFullYear(), 0, 1)) / (1000 * 60 * 60 * 24 * 7))).replace('{day}', Math.ceil((new Date() - new Date(new Date().getFullYear(), 0, 1)) / (1000 * 60 * 60 * 24)))"
          ></div>
          <div class="flex items-center space-x-2">
            <button
              @click="$store.settings.open()"
              :title="$t('header.settings')"
              class="ml-2"
            >
              <img
                src="%VITE_STATIC_PATH%/svg/gear.svg"
                alt=""
                class="h-6 w-6 text-gray-600 dark:text-gray-400 dark:invert"
                aria-hidden="true"
              />
            </button>
          </div>
        </header>
        <div
          class="category-slider-container dark:bg-dark-bg fixed z-[60] bg-white px-6 pb-12 shadow-[0_-4px_8px_rgba(0,0,0,0.1)] md:sticky md:top-0 md:px-0 md:py-2 md:shadow-none"
          :class="{ 
                        'bottom-0 left-0 right-0': $store.mobileUI.categoryHeaderPosition === 'bottom',
                        'top-0 left-0 right-0': $store.mobileUI.categoryHeaderPosition === 'top'
                    }"
          @touchstart="isScrolling = false"
          @touchmove="isScrolling = true"
          @touchend="setTimeout(() => isScrolling = false, 50)"
          role="navigation"
          x-data="{ 
                        hasOverflow: false,
                        checkOverflow() {
                            const tabs = document.querySelector('.category-tabs');
                            if (tabs) {
                                const newValue = tabs.scrollWidth > tabs.clientWidth;
                                if (newValue !== this.hasOverflow) {
                                    this.hasOverflow = newValue;
                                }
                            }
                        }
                    }"
          x-init="
                        $nextTick(() => {
                            checkOverflow();
                            // Set up mutation observer to watch for changes in category-tabs
                            const observer = new MutationObserver((mutations) => {
                                $nextTick(() => {
                                    checkOverflow();
                                    // Double check after a small delay
                                    setTimeout(() => {
                                        checkOverflow();
                                        $nextTick(() => checkOverflow());
                                    }, 100);
                                });
                            });
                            
                            const tabs = document.querySelector('.category-tabs');
                            if (tabs) {
                                observer.observe(tabs, {
                                    childList: true,
                                    subtree: true,
                                    attributes: true
                                });
                            }
                        });
                        window.addEventListener('resize', () => {
                            checkOverflow();
                            $nextTick(() => checkOverflow());
                        });
                    "
        >
          <div class="relative flex items-center">
            <div class="relative flex w-full items-center">
              <button
                @click="document.querySelector('.category-tabs').scrollBy({left: -200, behavior: 'smooth'})"
                class="relative -ml-1 hidden py-3 pr-4 text-gray-400 transition-colors hover:text-gray-600 focus:outline-none md:block dark:text-gray-500 dark:hover:text-gray-300"
                :class="{ 'md:hidden': !hasOverflow }"
                x-cloak
              >
                <svg
                  xmlns="http://www.w3.org/2000/svg"
                  class="h-4 w-4"
                  fill="none"
                  viewBox="0 0 24 24"
                  stroke="currentColor"
                  stroke-width="2.5"
                >
                  <path
                    stroke-linecap="round"
                    stroke-linejoin="round"
                    d="M15 19l-7-7 7-7"
                  />
                </svg>
              </button>
              <div
                class="category-tabs scrollbar-hide flex-1 overflow-x-auto"
                role="tablist"
                aria-label="News categories"
                @touchstart="isScrolling = false"
                @touchmove="isScrolling = true"
                @touchend="setTimeout(() => isScrolling = false, 50)"
                @scroll="checkOverflow()"
              >
                <template
                  x-for="category in availableCategories.filter(cat => $store.categories.isEnabled(cat.name))"
                  :key="category.name"
                >
                  <div
                    role="tab"
                    :aria-selected="currentCategory === category.name"
                    :aria-controls="'category-' + category.name"
                    class="category-tab whitespace-nowrap"
                    :class="{ 'active': currentCategory === category.name }"
                    @click="if (!isScrolling) { 
                                            currentCategory = category.name; 
                                            changeCategory(); 
                                            updateUrlWithArticleId('');
                                            
                                            
                                            // Scroll the category into view
                                            $el.scrollIntoView({ 
                                                behavior: 'smooth', 
                                                block: 'nearest',
                                                inline: 'center'
                                            });
                                        }"
                    x-text="category.name === 'OnThisDay' ? 
                            $t('category.todayInHistory') : 
                            $t(`category.${category.name.toLowerCase()}`) || category.name"
                  ></div>
                </template>
              </div>
              <button
                @click="document.querySelector('.category-tabs').scrollBy({left: 200, behavior: 'smooth'})"
                class="relative -mr-1 hidden py-3 pl-4 text-gray-400 transition-colors hover:text-gray-600 focus:outline-none md:block dark:text-gray-500 dark:hover:text-gray-300"
                :class="{ 'md:hidden': !hasOverflow }"
                x-cloak
              >
                <svg
                  xmlns="http://www.w3.org/2000/svg"
                  class="h-4 w-4"
                  fill="none"
                  viewBox="0 0 24 24"
                  stroke="currentColor"
                  stroke-width="2.5"
                >
                  <path
                    stroke-linecap="round"
                    stroke-linejoin="round"
                    d="M9 5l7 7-7 7"
                  />
                </svg>
              </button>
            </div>
          </div>
        </div>
        <div
          x-show="currentCategory === 'World' && $store.chaosIndex.score > 0"
          class="mb-4 flex items-center justify-between"
        >
          <div x-data="{ showChaosPopup: false }" class="relative">
            <div
              @click="setTimeout(() => showChaosPopup = true, 100)"
              class="flex cursor-pointer items-center justify-center rounded-md bg-gray-100 px-3 py-1.5 transition-colors duration-200 hover:bg-gray-200 dark:bg-gray-700 dark:hover:bg-gray-600"
              :title="$t('turbulence.tooltip')"
            >
              <span
                x-text="$store.chaosIndex.score"
                class="text-sm font-medium"
              ></span>
            </div>
            <div
              x-show="showChaosPopup"
              x-transition:enter="transition ease-out duration-300"
              x-transition:enter-start="opacity-0 transform scale-90"
              x-transition:enter-end="opacity-100 transform scale-100"
              x-transition:leave="transition ease-in duration-300"
              x-transition:leave-start="opacity-100 transform scale-100"
              x-transition:leave-end="opacity-0 transform scale-90"
              @click.away="showChaosPopup = false"
              @keydown.escape.window="showChaosPopup = false"
              class="bg-opacity-50 fixed inset-0 z-50 flex items-center justify-center bg-black p-4"
            >
              <div
                class="relative w-full max-w-md rounded-lg bg-white p-6 shadow-xl dark:bg-gray-800"
              >
                <button
                  @click="showChaosPopup = false"
                  class="absolute top-2 right-2 text-gray-500 hover:text-gray-700 dark:text-gray-400 dark:hover:text-gray-200"
                >
                  <svg
                    class="h-6 w-6"
                    fill="none"
                    stroke="currentColor"
                    viewBox="0 0 24 24"
                    xmlns="http://www.w3.org/2000/svg"
                  >
                    <path
                      stroke-linecap="round"
                      stroke-linejoin="round"
                      stroke-width="2"
                      d="M6 18L18 6M6 6l12 12"
                    />
                  </svg>
                </button>
                <h3
                  class="text-xl font-semibold text-gray-800 dark:text-gray-200"
                >
                  <span x-text="$t('turbulence.title')"></span>
                </h3>
                <p
                  class="mb-8 text-sm text-gray-600 dark:text-gray-400"
                  x-text="getLastUpdated()"
                ></p>
                <!-- Updated Progress Bar with Segments and Notches -->
                <div class="relative mb-4">
                  <!-- Chaos Index Score Display -->
                  <div class="absolute -top-6 right-0 left-0">
                    <span
                      x-text="$store.chaosIndex.score"
                      :style="{ left: $store.chaosIndex.score + '%', transform: 'translateX(-50%)' }"
                      style="position: absolute"
                      >50</span
                    >
                  </div>
                  <div
                    class="relative h-4 w-full overflow-hidden rounded-full bg-gray-200 dark:bg-gray-700"
                  >
                    <!-- Segmented Background -->
                    <div
                      class="absolute top-0 left-0 flex h-4 w-full overflow-hidden rounded-full"
                    >
                      <div
                        class="h-4 w-1/5"
                        style="background-color: #4caf50"
                      ></div>
                      <!-- 0-20 -->
                      <div
                        class="h-4 w-1/5"
                        style="background-color: #8bc34a"
                      ></div>
                      <!-- 21-40 -->
                      <div
                        class="h-4 w-1/5"
                        style="background-color: #ffeb3b"
                      ></div>
                      <!-- 41-60 -->
                      <div
                        class="h-4 w-1/5"
                        style="background-color: #ff9800"
                      ></div>
                      <!-- 61-80 -->
                      <div
                        class="h-4 w-1/5"
                        style="background-color: #f44336"
                      ></div>
                      <!-- 81-100 -->
                    </div>

                    <!-- Notches -->
                    <div
                      class="absolute top-0 left-[20%] h-4 w-0.5 bg-white"
                    ></div>
                    <div
                      class="absolute top-0 left-[40%] h-4 w-0.5 bg-white"
                    ></div>
                    <div
                      class="absolute top-0 left-[60%] h-4 w-0.5 bg-white"
                    ></div>
                    <div
                      class="absolute top-0 left-[80%] h-4 w-0.5 bg-white"
                    ></div>

                    <!-- Score Notch -->
                    <div
                      class="absolute top-0 h-4 w-1 bg-gray-500"
                      :style="{ left: $store.chaosIndex.score + '%' }"
                      :aria-valuenow="$store.chaosIndex.score"
                      aria-valuemin="0"
                      aria-valuemax="100"
                    ></div>
                  </div>
                  <!-- Labels -->
                  <div
                    class="absolute -bottom-5 left-0 text-xs text-gray-700 dark:text-gray-300"
                  >
                    0
                  </div>
                  <div
                    class="absolute -bottom-5 left-[20%] -translate-x-1/2 transform text-xs text-gray-700 dark:text-gray-300"
                  >
                    20
                  </div>
                  <div
                    class="absolute -bottom-5 left-[40%] -translate-x-1/2 transform text-xs text-gray-700 dark:text-gray-300"
                  >
                    40
                  </div>
                  <div
                    class="absolute -bottom-5 left-[60%] -translate-x-1/2 transform text-xs text-gray-700 dark:text-gray-300"
                  >
                    60
                  </div>
                  <div
                    class="absolute -bottom-5 left-[80%] -translate-x-1/2 transform text-xs text-gray-700 dark:text-gray-300"
                  >
                    80
                  </div>
                  <div
                    class="absolute right-0 -bottom-5 text-xs text-gray-700 dark:text-gray-300"
                  >
                    100
                  </div>
                </div>

                <!-- Current Bucket Description -->
                <p class="mt-8 text-sm text-gray-600 dark:text-gray-400">
                  <span class="font-semibold text-gray-800 dark:text-gray-200">
                    <span
                      x-text="$store.chaosIndex.getBucketDescription().split(':')[0] + ':'"
                    ></span>
                  </span>
                  <span
                    x-text="$store.chaosIndex.getBucketDescription().split(':')[1].trim()"
                  ></span>
                </p>

                <!-- Chaos Summary -->
                <p
                  class="mt-4 text-gray-600 dark:text-gray-400"
                  x-html="$store.chaosIndex.summary.replace(/\n/g, '<br>')"
                ></p>
              </div>
            </div>
          </div>
          <div class="flex items-center space-x-2">
            <button
              @click="viewMode = 'list'"
              :class="{'text-blue-500': viewMode === 'list', 'text-gray-500': viewMode !== 'list'}"
              :aria-label="$t('view.list')"
              :title="$t('view.list')"
            >
              <svg
                xmlns="http://www.w3.org/2000/svg"
                class="h-6 w-6"
                fill="none"
                viewBox="0 0 24 24"
                stroke="currentColor"
                aria-hidden="true"
              >
                <path
                  stroke-linecap="round"
                  stroke-linejoin="round"
                  stroke-width="2"
                  d="M4 6h16M4 10h16M4 14h16M4 18h16"
                />
              </svg>
            </button>
            <button
              @click="viewMode = 'map'"
              :class="{'text-blue-500': viewMode === 'map', 'text-gray-500': viewMode !== 'map'}"
              :aria-label="$t('view.map')"
              :title="$t('view.map')"
            >
              <svg
                xmlns="http://www.w3.org/2000/svg"
                class="h-6 w-6"
                fill="none"
                viewBox="0 0 24 24"
                stroke="currentColor"
                aria-hidden="true"
              >
                <path
                  stroke-linecap="round"
                  stroke-linejoin="round"
                  stroke-width="2"
                  d="M9 20l-5.447-2.724A1 1 0 013 16.382V5.618a1 1 0 011.447-.894L9 7m0 13l6-3m-6 3V7m6 10l4.553 2.276A1 1 0 0021 18.382V7.618a1 1 0 00-.553-.894L15 4m0 13V4m0 0L9 7"
                />
              </svg>
            </button>
          </div>
        </div>
        <div>
          <template x-if="viewMode === 'map' && currentCategory === 'World'">
            <div class="py-4">
              <iframe
                :src="'kite_map.html?timestamp=' + Date.now()"
                class="h-[calc(100vh-200px)] w-full border-none"
              ></iframe>
            </div>
          </template>
          <template
            x-if="viewMode === 'list' && currentCategory === 'OnThisDay'"
          >
            <div
              class="py-4"
              x-data="{ hoveredLink: null, popupContent: null, popupVisible: false, popupPosition: { x: 0, y: 0 } }"
            >
              <!-- Events Section -->
              <div class="mb-8">
                <h3
                  class="mb-4 text-2xl font-bold text-gray-700 dark:text-gray-300"
                >
                  <span x-text="$t('onthisday.events')"></span>
                </h3>

                <template
                  x-for="(event, index) in stories.filter(e => e.type === 'event')"
                  :key="index"
                >
                  <!--Switch to 2-column grid on md+, left-align items -->
                  <div
                    class="relative flex flex-col pb-6 before:absolute before:top-[14px] before:bottom-[-16px] before:left-[3px] before:w-[2px] before:bg-[var(--color-header)] before:content-[''] last:pb-0 last:before:content-none md:grid md:grid-cols-[auto_1fr] md:items-start md:justify-items-start md:gap-4"
                  >
                    <!-- Dot + Year -->
                    <div class="flex items-center">
                      <!-- Dot -->
                      <span
                        class="relative z-10 h-2 w-2 rounded-full bg-[var(--color-header)]"
                      ></span>

                      <!-- Year -->
                      <span
                        class="ml-2 pl-2 text-2xl font-bold text-[var(--color-header)]"
                        x-text="event.year"
                      ></span>
                    </div>

                    <!-- Text -->
                    <!-- On mobile, it's below the dot+year; on md+ it's in the second column -->
                    <div class="mt-2 pl-6 md:mt-0 md:pl-0">
                      <span
                        class="text-sm text-gray-700 dark:text-gray-300"
                        x-html="event.content.replace(/href=/g, 'class=\'underline\' href=')"
                      ></span>
                    </div>
                  </div>
                </template>
              </div>

              <!-- People Section Carousel -->
              <div x-data="peopleCarousel(stories)">
                <h3
                  class="mb-4 text-2xl font-bold text-gray-700 dark:text-gray-300"
                >
                  <span x-text="$t('onthisday.people')"></span>
                </h3>

                <!-- ============ DESKTOP CAROUSEL (md and up) ============ -->
                <div class="relative hidden md:block">
                  <!-- Left Arrow -->
                  <button
                    class="absolute top-1/2 left-[-2rem] -translate-y-1/2 cursor-pointer rounded px-2 py-1 text-gray-400 transition-colors hover:text-gray-600 disabled:opacity-50 dark:text-gray-500 dark:hover:text-gray-300"
                    @click="prevSlide"
                    :disabled="currentSlide === 0"
                  >
                    <svg
                      xmlns="http://www.w3.org/2000/svg"
                      class="h-4 w-4"
                      fill="none"
                      viewBox="0 0 24 24"
                      stroke="currentColor"
                      stroke-width="2.5"
                    >
                      <path
                        stroke-linecap="round"
                        stroke-linejoin="round"
                        d="M15 19l-7-7 7-7"
                      />
                    </svg>
                  </button>

                  <!-- Slides Wrapper (overflow hidden) -->
                  <div class="overflow-hidden" @wheel="onWheel($event)">
                    <!-- Inner track that slides back & forth -->
                    <div
                      class="flex transition-transform duration-300 ease-out"
                      :style="`transform: translateX(-${currentSlide * 100}%)`"
                    >
                      <!-- Each "slide" is a group of up to 3 stories -->
                      <template
                        x-for="(slide, sIndex) in chunkedStories"
                        :key="sIndex"
                      >
                        <div class="flex w-full shrink-0 justify-around">
                          <!-- Each story card within the slide -->
                          <template
                            x-for="(event, index) in slide"
                            :key="index"
                          >
                            <div
                              class="relative flex w-1/3 flex-col items-center px-4 text-center"
                            >
                              <!-- Vertical separator between cards (except last card in the slide) -->
                              <div
                                x-show="index < slide.length - 1"
                                class="absolute top-0 right-0 h-full w-[1px] bg-[var(--color-header)]"
                              ></div>

                              <!-- YEAR -->
                              <span
                                class="mr-auto mb-2 text-2xl font-bold text-[var(--color-header)]"
                                x-text="event.year"
                              ></span>

                              <!-- IMAGE + TEXT -->
                              <div class="flex items-start gap-4">
                                <!-- IMAGE -->
                                <img
                                  class="h-10 w-10 flex-shrink-0 rounded-full object-cover"
                                  :src="event.image || '%VITE_STATIC_PATH%/svg/placeholder.svg'"
                                  alt="placeholder"
                                />

                                <!-- TEXT -->
                                <span
                                  class="text-left text-sm text-gray-700 dark:text-gray-300"
                                  x-html="event.content.replace(/href=/g, 'class=\'underline\' href=')"
                                ></span>
                              </div>
                            </div>
                          </template>
                        </div>
                      </template>
                    </div>
                  </div>

                  <!-- Right Arrow -->
                  <button
                    class="absolute top-1/2 right-[-2rem] -translate-y-1/2 cursor-pointer rounded px-2 py-1 text-gray-400 transition-colors hover:text-gray-600 disabled:opacity-50 dark:text-gray-500 dark:hover:text-gray-300"
                    @click="nextSlide"
                    :disabled="currentSlide >= chunkedStories.length - 1"
                  >
                    <svg
                      xmlns="http://www.w3.org/2000/svg"
                      class="h-4 w-4"
                      fill="none"
                      viewBox="0 0 24 24"
                      stroke="currentColor"
                      stroke-width="2.5"
                    >
                      <path
                        stroke-linecap="round"
                        stroke-linejoin="round"
                        d="M9 5l7 7-7 7"
                      />
                    </svg>
                  </button>

                  <!-- Pagination Dots (Desktop) -->
                  <div class="mt-8 flex justify-center space-x-2">
                    <template x-for="(slide, i) in chunkedStories" :key="i">
                      <span
                        class="block h-2 w-2 cursor-pointer rounded-full transition-colors"
                        :class="currentSlide === i 
                                                ? 'bg-[var(--color-header)]' 
                                                : 'bg-gray-300 dark:bg-gray-600'"
                        @click="goToSlide(i)"
                      ></span>
                    </template>
                  </div>
                </div>

                <!-- ============ MOBILE HORIZONTAL SCROLL (below md) ============ -->
                <div
                  class="horizontal-scroll-container flex space-x-4 overflow-x-auto md:hidden"
                  @touchstart="isScrolling = true"
                  @touchend="setTimeout(() => isScrolling = false, 50)"
                >
                  <!-- Show *all* filtered stories in one row; user can scroll -->
                  <template
                    x-for="(event, index) in peopleStories"
                    :key="index"
                  >
                    <div
                      class="relative flex min-w-[200px] flex-col items-center px-2 text-center"
                    >
                      <!-- Vertical line between items (except the last one) -->
                      <div
                        x-show="index < peopleStories.length - 1"
                        class="absolute top-0 right-0 h-full w-[1px] bg-[var(--color-header)]"
                      ></div>

                      <!-- YEAR -->
                      <span
                        class="mb-2 text-lg font-bold text-[var(--color-header)]"
                        x-text="event.year"
                      ></span>

                      <!-- IMAGE -->
                      <img
                        class="mb-2 h-20 w-20 rounded-full object-cover"
                        :src="event.image || '%VITE_STATIC_PATH%/svg/placeholder.svg'"
                        alt="placeholder"
                      />

                      <!-- TEXT -->
                      <span
                        class="text-gray-700 dark:text-gray-300"
                        x-html="event.content.replace(/href=/g, 'class=\'underline\' href=')"
                      ></span>
                    </div>
                  </template>
                </div>
              </div>

              <!-- Wikipedia Popup -->
              <div
                x-show="popupVisible"
                x-transition:enter="transition ease-out duration-200"
                x-transition:enter-start="opacity-0 translate-y-4"
                x-transition:enter-end="opacity-100 translate-y-0"
                x-transition:leave="transition ease-in duration-150"
                x-transition:leave-start="opacity-100 translate-y-0"
                x-transition:leave-end="opacity-0 translate-y-4"
                class="fixed inset-0 z-50 flex flex-col bg-white md:max-h-[80vh] md:w-[90vw] md:max-w-sm md:overflow-hidden md:rounded-lg md:shadow-xl dark:bg-gray-800"
                :class="{
                                    'md:absolute': window.innerWidth > 768,
                                    'md:left-[${popupPosition.x}px] md:top-[${popupPosition.y}px]': window.innerWidth > 768
                                }"
              >
                <!-- Mobile Header -->
                <div
                  class="flex items-center justify-between border-b border-gray-200 p-4 md:hidden dark:border-gray-700"
                >
                  <h3
                    class="text-lg font-semibold text-gray-800 dark:text-gray-200"
                    x-text="popupContent?.title"
                  ></h3>
                  <button
                    @click="popupVisible = false"
                    class="rounded-full p-2 transition-colors hover:bg-gray-100 dark:hover:bg-gray-700"
                  >
                    <svg
                      class="h-6 w-6 text-gray-600 dark:text-gray-300"
                      fill="none"
                      stroke="currentColor"
                      viewBox="0 0 24 24"
                    >
                      <path
                        stroke-linecap="round"
                        stroke-linejoin="round"
                        stroke-width="2"
                        d="M6 18L18 6M6 6l12 12"
                      ></path>
                    </svg>
                  </button>
                </div>

                <!-- Image Section -->
                <div
                  x-show="popupContent?.thumbnail"
                  class="relative h-48 w-full"
                >
                  <img
                    :src="popupContent?.thumbnail?.source"
                    :alt="popupContent?.title"
                    class="h-full w-full object-cover"
                    loading="lazy"
                  />
                  <div
                    class="absolute inset-0 bg-gradient-to-t from-black/30 to-transparent"
                  ></div>
                  <h3
                    class="absolute bottom-4 left-4 hidden text-xl font-bold text-white md:block"
                    x-text="popupContent?.title"
                  ></h3>
                </div>

                <!-- Content Section -->
                <div class="flex-1 overflow-y-auto p-4 md:p-6">
                  <!-- Description -->
                  <p
                    x-show="popupContent?.description"
                    class="mb-4 text-sm leading-relaxed text-gray-600 dark:text-gray-300"
                    x-text="popupContent?.description"
                  ></p>

                  <!-- Main Content -->
                  <div class="prose prose-sm dark:prose-invert max-w-none">
                    <p x-html="popupContent?.extract_html"></p>
                  </div>

                  <!-- Read More Link -->
                  <div class="mt-4">
                    <a
                      :href="'https://en.wikipedia.org/wiki/' + encodeURIComponent(popupContent?.title)"
                      target="_blank"
                      class="inline-flex items-center text-blue-600 hover:underline dark:text-blue-400"
                    >
                      <span x-text="$t('wikipedia.readMore')"></span>
                      <svg
                        class="ml-1 h-4 w-4"
                        fill="none"
                        stroke="currentColor"
                        viewBox="0 0 24 24"
                      >
                        <path
                          stroke-linecap="round"
                          stroke-linejoin="round"
                          stroke-width="2"
                          d="M10 6H6a2 2 0 00-2 2v10a2 2 0 002 2h10a2 2 0 002-2v-4M14 4h6m0 0v6m0-6L10 14"
                        ></path>
                      </svg>
                    </a>
                  </div>
                </div>

                <!-- Close Button (Desktop) -->
                <button
                  @click="popupVisible = false"
                  class="absolute top-2 right-2 hidden rounded-full bg-white/80 p-2 backdrop-blur-sm transition-colors hover:bg-gray-100 md:block dark:bg-gray-700/80 dark:hover:bg-gray-600"
                >
                  <svg
                    class="h-5 w-5 text-gray-600 dark:text-gray-300"
                    fill="none"
                    stroke="currentColor"
                    viewBox="0 0 24 24"
                  >
                    <path
                      stroke-linecap="round"
                      stroke-linejoin="round"
                      stroke-width="2"
                      d="M6 18L18 6M6 6l12 12"
                    ></path>
                  </svg>
                </button>

                <!-- Mobile Footer -->
                <div
                  class="border-t border-gray-200 p-4 md:hidden dark:border-gray-700"
                >
                  <button
                    @click="popupVisible = false"
                    class="w-full rounded-lg bg-gray-100 px-4 py-2 text-gray-800 transition-colors hover:bg-gray-200 dark:bg-gray-700 dark:text-gray-200 dark:hover:bg-gray-600"
                  >
                    <span x-text="$t('ui.close')"></span>
                  </button>
                </div>
              </div>
            </div>
          </template>
          <template x-if="currentCategory !== 'OnThisDay'">
            <template
              x-for="(story, index) in stories"
              :key="story.category + story.cluster_number"
            >
              <article
                :id="'story-' + index"
                role="article"
                :aria-expanded="story.expanded"
                :aria-label="'News story: ' + story.title"
                class="relative py-2"
                :class="{'border-b border-gray-200 dark:border-gray-700': !story.expanded}"
              >
                <header class="mb-1 flex items-center justify-between">
                  <span
                    class="category-label inline-flex items-center rounded py-1 text-sm text-gray-700 dark:text-gray-300"
                  >
                    <span
                      :class="'topic-color-' + ((story.category.charCodeAt(0) + story.category.charCodeAt(1) + story.category.length) % 9 + 1)"
                      x-text="story.category"
                    ></span>

                    <span
                      x-show="$store.experimental.showCategoryIcons && story.emoji"
                      class="ml-2 text-xl"
                      x-text="story.emoji"
                    ></span>
                  </span>
                </header>
                <div class="flex items-start">
                  <div class="flex-grow">
                    <h2
                      class="dark:text-dark-text mb-2 flex cursor-pointer items-center text-xl text-gray-800"
                      :class="readStories[story.title] ? '' : 'font-semibold'"
                      @click="toggleStory(story, index)"
                      :id="'story-title-' + index"
                    >
                      <span
                        x-show="$store.experimental.showArticleIcons && story.emoji"
                        class="mr-2 text-xl"
                        x-text="story.emoji"
                      ></span>
                      <span x-text="story.title"></span>
                    </h2>
                  </div>
                  <div class="-mt-3 ml-4 flex-shrink-0">
                    <button
                      @click.stop="readStories[story.title] = !readStories[story.title]; localStorage.setItem('readStories', JSON.stringify(readStories))"
                      class="focus:outline-none"
                    >
                      <svg
                        :class="readStories[story.title] ? 'text-gray-600 dark:text-gray-400' : 'text-gray-300 dark:text-gray-600'"
                        class="h-6 w-6"
                        xmlns="http://www.w3.org/2000/svg"
                        viewBox="0 0 19 19"
                        :fill="readStories[story.title] ? '#7BA3FF' : 'currentColor'"
                        :stroke="readStories[story.title] ? '#427AFC' : 'none'"
                        :title="$t('article.readStatus')"
                      >
                        <path
                          fill-rule="evenodd"
                          d="M10 18a8 8 0 100-16 8 8 0 000 16zm3.707-9.293a1 1 0 00-1.414-1.414L9 10.586 7.707 9.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z"
                          clip-rule="evenodd"
                        />
                      </svg>
                    </button>
                  </div>
                </div>

                <section
                  x-show="story.expanded"
                  class="dark:bg-dark-bg flex flex-col bg-white py-4"
                  @click.stop
                  x-effect="$store.sections.order"
                >
                  <section
                    x-show="$store.sections.settings.summary"
                    :class="'order-' + $store.sections.order.indexOf('summary')"
                    class="mt-6"
                  >
                    <p
                      x-show="$store.sections.settings.summary"
                      class="mb-6"
                      x-text="story.short_summary"
                    ></p>
                    <p
                      x-show="story.location"
                      class="flex cursor-pointer items-center text-gray-600 dark:text-gray-300"
                      @click="openMaps(story.location)"
                      :title="$t('article.location')"
                    >
                      <img
                        src="%VITE_STATIC_PATH%/svg/map.svg"
                        alt="Map icon"
                        class="mr-2 h-5 w-5"
                      />
                      <span x-text="story.location"></span>
                    </p>
                  </section>

                  <section
                    x-show="story.articles.some(a => a.image) && $store.sections.settings.primaryImage"
                    :class="'order-[' + $store.sections.order.indexOf('primaryImage') + ']'"
                    class="mt-6"
                  >
                    <figure>
                      <div class="relative">
                        <template
                          x-if="story.articles.find(a => a.image) && $store.sections.settings.primaryImage"
                        >
                          <div
                            class="relative mx-auto w-[calc(100%-1rem)] max-w-[800px]"
                          >
                            <a
                              :href="story.articles.find(a => a.image).link"
                              target="_blank"
                              class="relative block"
                            >
                              <img
                                :src="story.articles.find(a => a.image).image"
                                :alt="story.articles.find(a => a.image).image_caption || 'Story image'"
                                class="h-auto w-full rounded-lg shadow-md"
                                loading="lazy"
                              />
                              <div
                                class="bg-opacity-50 hover:bg-opacity-75 absolute right-2 bottom-2 rounded bg-black px-2 py-1 text-sm text-white"
                              >
                                <span
                                  x-text="story.articles.find(a => a.image).domain"
                                ></span>
                              </div>
                            </a>
                            <template
                              x-if="story.articles.find(a => a.image).image_caption"
                            >
                              <p
                                class="mt-2 text-sm text-gray-600 italic dark:text-gray-400"
                                x-text="story.articles.find(a => a.image).image_caption"
                              ></p>
                            </template>
                          </div>
                        </template>
                      </div>
                    </figure>
                  </section>

                  <section
                    x-show="$store.sections.settings.highlights"
                    :class="'order-[' + $store.sections.order.indexOf('highlights') + ']'"
                    class="mt-6"
                  >
                    <h3
                      class="mb-4 text-xl font-semibold text-gray-800 dark:text-gray-200"
                    >
                      <span x-text="$t('section.highlights')"></span>
                    </h3>
                    <div
                      class="border-t border-dashed border-gray-300 dark:border-gray-600"
                    >
                      <template
                        x-for="(point, index) in story.talking_points"
                        :key="point"
                      >
                        <div
                          class="relative border-b border-dashed border-gray-300 py-4 pl-10 dark:border-gray-600"
                        >
                          <div class="absolute top-4 left-0">
                            <div
                              class="flex h-6 w-6 items-center justify-center rounded-full bg-[#F9D9B8]"
                            >
                              <span
                                class="text-sm font-semibold text-gray-800"
                                x-text="index + 1"
                              ></span>
                            </div>
                          </div>
                          <template x-if="point.includes(':')">
                            <div>
                              <div class="flex items-start">
                                <h4
                                  class="mb-2 font-semibold text-gray-800 dark:text-gray-200"
                                  x-text="point.split(':')[0].trim()"
                                ></h4>
                              </div>
                              <p
                                class="-ml-10 text-gray-700 dark:text-gray-300"
                                x-text="point.split(':')[1].trim()"
                              ></p>
                            </div>
                          </template>
                          <template x-if="!point.includes(':')">
                            <p
                              class="text-gray-700 dark:text-gray-300"
                              x-text="point"
                            ></p>
                          </template>
                        </div>
                      </template>
                    </div>
                  </section>

                  <section
                    x-show="story.quote && $store.sections.settings.quotes"
                    class="my-8 rounded-lg bg-[#F3F6FE] p-4 dark:bg-gray-700"
                    :class="'order-[' + $store.sections.order.indexOf('quotes') + ']'"
                  >
                    <blockquote class="text-lg text-black dark:text-white">
                      <span x-text="story.quote"></span>
                    </blockquote>
                    <p
                      x-show="story.quote_author"
                      class="mt-2 text-left text-gray-700 dark:text-gray-300"
                    >
                      <template x-if="story.quote_source_url">
                        <a
                          :href="story.quote_source_url"
                          target="_blank"
                          rel="noopener noreferrer"
                          class="text-[#183FDC] hover:underline dark:text-[#5B89FF]"
                        >
                          <span
                            x-text="story.quote_author + (story.quote_source_domain ? ' (via ' + story.quote_source_domain + ')' : '')"
                          ></span>
                        </a>
                      </template>
                      <template x-if="!story.quote_source_url">
                        <span x-text="story.quote_author"></span>
                      </template>
                    </p>
                  </section>

                  <section
                    x-show="story.articles.filter(a => a.image).length >= 2 && $store.sections.settings.secondaryImage"
                    class="mt-6"
                    :class="'order-[' + $store.sections.order.indexOf('secondaryImage') + ']'"
                  >
                    <template
                      x-if="story.articles.filter(a => a.image)[1] && $store.sections.settings.secondaryImage"
                    >
                      <div
                        class="relative mx-auto w-[calc(100%-1rem)] max-w-[800px]"
                      >
                        <a
                          :href="story.articles.filter(a => a.image)[1].link"
                          target="_blank"
                          class="relative block"
                        >
                          <img
                            :src="story.expanded ? story.articles.filter(a => a.image)[1].image : ''"
                            :alt="story.articles.filter(a => a.image)[1].image_caption || 'Additional story image'"
                            loading="lazy"
                            class="h-auto w-full rounded-lg shadow-md"
                          />
                          <div
                            class="bg-opacity-50 hover:bg-opacity-75 absolute right-2 bottom-2 rounded bg-black px-2 py-1 text-sm text-white"
                          >
                            <span
                              x-text="story.articles.filter(a => a.image)[1].domain"
                            ></span>
                          </div>
                        </a>
                        <template
                          x-if="story.articles.filter(a => a.image)[1].image_caption"
                        >
                          <p
                            class="mt-2 text-sm text-gray-600 italic dark:text-gray-400"
                            x-text="story.articles.filter(a => a.image)[1].image_caption"
                          ></p>
                        </template>
                      </div>
                    </template>
                  </section>

                  <section
                    x-show="story.perspectives && story.perspectives.length > 0 && $store.sections.settings.perspectives"
                    class="mt-6"
                    :class="'order-[' + $store.sections.order.indexOf('perspectives') + ']'"
                  >
                    <h3
                      class="mb-4 text-xl font-semibold text-gray-800 dark:text-gray-200"
                    >
                      <span x-text="$t('section.perspectives')"></span>
                    </h3>
                    <div
                      class="horizontal-scroll-container flex flex-row gap-3 overflow-x-auto pb-4"
                      @touchstart="isScrolling = true"
                      @touchend="setTimeout(() => isScrolling = false, 50)"
                    >
                      <template
                        x-for="(perspective, index) in story.perspectives"
                        :key="index"
                      >
                        <div
                          class="w-56 flex-shrink-0 rounded-lg bg-gray-100 p-4 dark:bg-gray-700"
                        >
                          <p
                            class="mb-2 font-bold text-gray-800 dark:text-gray-200"
                            x-text="perspective.text.includes(':') ? perspective.text.split(':')[0] : ''"
                          ></p>
                          <p
                            class="mb-2 text-gray-700 dark:text-gray-300"
                            x-text="perspective.text.includes(':') ? perspective.text.split(':').slice(1).join(':').trim() : perspective.text"
                          ></p>
                          <template
                            x-if="perspective.sources && perspective.sources.length > 0"
                          >
                            <div
                              class="mt-2 text-sm text-gray-600 dark:text-gray-400"
                            >
                              <template
                                x-for="(source, index) in perspective.sources"
                                :key="index"
                              >
                                <span>
                                  <a
                                    :href="source.url"
                                    target="_blank"
                                    rel="noopener noreferrer"
                                    class="text-[#183FDC] hover:underline dark:text-[#5B89FF]"
                                    x-text="source.name"
                                  ></a>
                                  <template
                                    x-if="index < perspective.sources.length - 1"
                                  >
                                    <span> • </span>
                                  </template>
                                </span>
                              </template>
                            </div>
                          </template>
                        </div>
                      </template>
                    </div>
                  </section>

                  <section
                    x-show="story.historical_background && $store.sections.settings.historicalBackground"
                    :class="'order-[' + $store.sections.order.indexOf('historicalBackground') + ']'"
                  >
                    <h3
                      class="mt-6 mb-2 text-xl font-semibold text-gray-800 dark:text-gray-200"
                    >
                      <span x-text="$t('section.historicalBackground')"></span>
                    </h3>
                    <p
                      class="mb-4 text-gray-700 dark:text-gray-300"
                      x-text="story.historical_background"
                    ></p>
                  </section>

                  <section
                    x-show="story.humanitarian_impact && $store.sections.settings.humanitarianImpact"
                    :class="'order-[' + $store.sections.order.indexOf('humanitarianImpact') + ']'"
                  >
                    <h3
                      class="mt-6 mb-2 text-xl font-semibold text-gray-800 dark:text-gray-200"
                    >
                      <span x-text="$t('section.humanitarianImpact')"></span>
                    </h3>
                    <p
                      class="mb-4 text-gray-700 dark:text-gray-300"
                      x-text="story.humanitarian_impact"
                      :class="'order-[' + $store.sections.order.indexOf('humanitarianImpact') + ']'"
                    ></p>
                  </section>

                  <section
                    x-show="story.technical_details && story.technical_details.length > 0 && $store.sections.settings.technicalDetails"
                    :class="'order-[' + $store.sections.order.indexOf('technicalDetails') + ']'"
                  >
                    <h3
                      class="mt-6 mb-2 text-xl font-semibold text-gray-800 dark:text-gray-200"
                    >
                      <span x-text="$t('section.technicalDetails')"></span>
                    </h3>
                    <ul
                      class="mb-4 list-inside list-disc space-y-2 text-gray-700 dark:text-gray-300"
                    >
                      <template
                        x-for="detail in story.technical_details"
                        :key="detail"
                      >
                        <li x-text="detail"></li>
                      </template>
                    </ul>
                  </section>

                  <section
                    x-show="(story.business_angle_text || (story.business_angle_points && story.business_angle_points.length > 0)) && $store.sections.settings.businessAngle"
                    :class="'order-[' + $store.sections.order.indexOf('businessAngle') + ']'"
                  >
                    <h3
                      class="mt-6 mb-2 text-xl font-semibold text-gray-800 dark:text-gray-200"
                    >
                      <span x-text="$t('section.businessAngle')"></span>
                    </h3>
                    <p
                      x-show="story.business_angle_text"
                      class="mb-4 text-gray-700 dark:text-gray-300"
                      x-text="story.business_angle_text"
                    ></p>
                    <ul
                      x-show="story.business_angle_points && story.business_angle_points.length > 0"
                      class="mb-4 list-inside list-disc space-y-2 text-gray-700 dark:text-gray-300"
                    >
                      <template
                        x-for="point in story.business_angle_points"
                        :key="point"
                      >
                        <li x-text="point"></li>
                      </template>
                    </ul>
                  </section>

                  <section
                    x-show="story.international_reactions && story.international_reactions.length > 0 && $store.sections.settings.internationalReactions"
                    :class="'order-[' + $store.sections.order.indexOf('internationalReactions') + ']'"
                  >
                    <h3
                      class="mt-6 mb-2 text-xl font-semibold text-gray-800 dark:text-gray-200"
                    >
                      <span
                        x-text="$t('section.internationalReactions')"
                      ></span>
                    </h3>
                    <div class="space-y-2">
                      <template
                        x-for="reaction in story.international_reactions"
                        :key="reaction"
                      >
                        <div
                          class="rounded-lg bg-gray-100 p-4 dark:bg-gray-700"
                        >
                          <template
                            x-if="typeof reaction === 'string' && reaction.includes(':')"
                          >
                            <div>
                              <h4
                                class="font-semibold text-gray-800 dark:text-gray-200"
                                x-text="reaction.split(':')[0].trim()"
                              ></h4>
                              <p
                                class="text-gray-700 dark:text-gray-300"
                                x-text="reaction.split(':')[1].trim().endsWith('.') ? reaction.split(':')[1].trim() : reaction.split(':')[1].trim() + '.'"
                              ></p>
                            </div>
                          </template>
                          <template
                            x-if="typeof reaction === 'string' && !reaction.includes(':')"
                          >
                            <p
                              class="text-gray-700 dark:text-gray-300"
                              x-text="reaction.endsWith('.') ? reaction : reaction + '.'"
                            ></p>
                          </template>
                          <template x-if="typeof reaction !== 'string'">
                            <p class="text-gray-700 dark:text-gray-300">
                              Invalid reaction format
                            </p>
                          </template>
                        </div>
                      </template>
                    </div>
                  </section>

                  <section
                    x-show="story.scientific_significance && story.scientific_significance.length > 0 && $store.sections.settings.otherDetails"
                    :class="'order-[' + $store.sections.order.indexOf('otherDetails') + ']'"
                  >
                    <h3
                      class="mt-6 mb-2 text-xl font-semibold text-gray-800 dark:text-gray-200"
                    >
                      <span
                        x-text="$t('section.scientificSignificance')"
                      ></span>
                    </h3>
                    <ul
                      class="mb-4 list-inside list-disc space-y-2 text-gray-700 dark:text-gray-300"
                    >
                      <template
                        x-for="point in story.scientific_significance"
                        :key="point"
                      >
                        <li x-text="point"></li>
                      </template>
                    </ul>
                  </section>

                  <section
                    x-show="story.travel_advisory && story.travel_advisory.length > 0 && $store.sections.settings.otherDetails"
                    :class="'order-[' + $store.sections.order.indexOf('otherDetails') + ']'"
                  >
                    <h3
                      class="mt-6 mb-2 text-xl font-semibold text-gray-800 dark:text-gray-200"
                    >
                      <span x-text="$t('section.travelAdvisory')"></span>
                    </h3>
                    <ul
                      class="mb-4 list-inside list-disc space-y-2 text-gray-700 dark:text-gray-300"
                    >
                      <template
                        x-for="point in story.travel_advisory"
                        :key="point"
                      >
                        <li x-text="point"></li>
                      </template>
                    </ul>
                  </section>

                  <section
                    x-show="story.performance_statistics && story.performance_statistics.length > 0 && $store.sections.settings.otherDetails"
                    :class="'order-[' + $store.sections.order.indexOf('otherDetails') + ']'"
                  >
                    <h3
                      class="mt-6 mb-2 text-xl font-semibold text-gray-800 dark:text-gray-200"
                    >
                      <span x-text="$t('section.performanceStatistics')"></span>
                    </h3>
                    <ul
                      class="mb-4 list-inside list-disc space-y-2 text-gray-700 dark:text-gray-300"
                    >
                      <template
                        x-for="stat in story.performance_statistics"
                        :key="stat"
                      >
                        <li x-text="stat"></li>
                      </template>
                    </ul>
                  </section>

                  <section
                    x-show="story.league_standings && $store.sections.settings.otherDetails"
                    :class="'order-[' + $store.sections.order.indexOf('otherDetails') + ']'"
                  >
                    <h3
                      class="mt-6 mb-2 text-xl font-semibold text-gray-800 dark:text-gray-200"
                    >
                      <span x-text="$t('section.leagueStandings')"></span>
                    </h3>
                    <p
                      class="mb-4 text-gray-700 dark:text-gray-300"
                      x-text="story.league_standings"
                    ></p>
                  </section>

                  <section
                    x-show="story.design_principles && $store.sections.settings.otherDetails"
                    :class="'order-[' + $store.sections.order.indexOf('otherDetails') + ']'"
                  >
                    <h3
                      class="mt-6 mb-2 text-xl font-semibold text-gray-800 dark:text-gray-200"
                    >
                      <span x-text="$t('section.designPrinciples')"></span>
                    </h3>
                    <p
                      class="mb-4 text-gray-700 dark:text-gray-300"
                      x-text="story.design_principles"
                    ></p>
                  </section>

                  <section
                    x-show="story.user_experience_impact && story.user_experience_impact.length > 0 && $store.sections.settings.otherDetails"
                    :class="'order-[' + $store.sections.order.indexOf('otherDetails') + ']'"
                  >
                    <h3
                      class="mt-6 mb-2 text-xl font-semibold text-gray-800 dark:text-gray-200"
                    >
                      <span x-text="$t('section.userExperienceImpact')"></span>
                    </h3>
                    <ul
                      class="mb-4 list-inside list-disc text-gray-700 dark:text-gray-300"
                    >
                      <template
                        x-for="impact in story.user_experience_impact"
                        :key="impact"
                      >
                        <li x-text="impact"></li>
                      </template>
                    </ul>
                  </section>

                  <section
                    x-show="story.gameplay_mechanics && story.gameplay_mechanics.length > 0 && $store.sections.settings.otherDetails"
                    :class="'order-[' + $store.sections.order.indexOf('otherDetails') + ']'"
                  >
                    <h3
                      class="mt-6 mb-2 text-xl font-semibold text-gray-800 dark:text-gray-200"
                    >
                      <span x-text="$t('section.gameplayMechanics')"></span>
                    </h3>
                    <ul
                      class="mb-4 list-inside list-disc text-gray-700 dark:text-gray-300"
                    >
                      <template
                        x-for="mechanic in story.gameplay_mechanics"
                        :key="mechanic"
                      >
                        <li x-text="mechanic"></li>
                      </template>
                    </ul>
                  </section>

                  <section
                    x-show="story.gaming_industry_impact && story.gaming_industry_impact.length > 0 && $store.sections.settings.otherDetails"
                    :class="'order-[' + $store.sections.order.indexOf('otherDetails') + ']'"
                  >
                    <h3
                      class="mt-6 mb-2 text-xl font-semibold text-gray-800 dark:text-gray-200"
                    >
                      <span x-text="$t('section.industryImpact')"></span>
                    </h3>
                    <ul
                      class="mb-4 list-inside list-disc text-gray-700 dark:text-gray-300"
                    >
                      <template
                        x-for="impact in story.gaming_industry_impact"
                        :key="impact"
                      >
                        <li x-text="impact"></li>
                      </template>
                    </ul>
                  </section>

                  <section
                    x-show="story.technical_specifications && $store.sections.settings.otherDetails"
                    :class="'order-[' + $store.sections.order.indexOf('otherDetails') + ']'"
                  >
                    <h3
                      class="mt-6 mb-2 text-xl font-semibold text-gray-800 dark:text-gray-200"
                    >
                      <span
                        x-text="$t('section.technicalSpecifications')"
                      ></span>
                    </h3>
                    <p
                      class="mb-4 text-gray-700 dark:text-gray-300"
                      x-text="story.technical_specifications"
                    ></p>
                  </section>

                  <section
                    x-show="story.timeline && story.timeline.length > 0 && $store.sections.settings.timeline"
                    :class="'order-[' + $store.sections.order.indexOf('timeline') + ']'"
                  >
                    <h2 class="timeline-title mt-6 mb-4 text-xl font-semibold">
                      <span x-text="$t('section.timeline')"></span>
                    </h2>
                    <div class="timeline">
                      <template
                        x-for="(event, index) in story.timeline"
                        :key="index"
                      >
                        <div class="row">
                          <div class="head">
                            <span class="step"></span>
                            <span
                              class="item-title"
                              x-text="typeof event === 'object' ? event.date : 
                                                        (typeof event === 'string' && event.includes('::')) ? event.split('::')[0] : ''"
                            ></span>
                          </div>
                          <div class="body">
                            <span
                              x-text="typeof event === 'object' ? event.description :
                                                        (typeof event === 'string' && event.includes('::')) ? event.split('::').slice(1).join(':') : event"
                            ></span>
                          </div>
                        </div>
                      </template>
                    </div>
                  </section>

                  <section
                    x-data="{ showAllSources: false, visibleSources: window.innerWidth <= 768 ? 4 : 8 }"
                    x-init="window.addEventListener('resize', () => { visibleSources = window.innerWidth <= 768 ? 4 : 8 })"
                    x-show="$store.sections.settings.sources"
                    :class="'order-[' + $store.sections.order.indexOf('sources') + ']'"
                  >
                    <div class="mt-6 mb-4 flex items-center justify-between">
                      <h3
                        class="text-xl font-semibold text-gray-800 dark:text-gray-200"
                      >
                        <span x-text="$t('section.sources')"></span>
                      </h3>
                      <button
                        x-show="story.domains && story.domains.length > visibleSources"
                        @click="showAllSources = !showAllSources"
                        class="text-gray-600 hover:text-gray-800 focus:outline-none dark:text-gray-400 dark:hover:text-gray-200"
                      >
                        <svg
                          xmlns="http://www.w3.org/2000/svg"
                          class="ml-1 inline-block h-5 w-5 transform transition-transform duration-200"
                          :class="{'rotate-180': showAllSources}"
                          fill="none"
                          viewBox="0 0 24 24"
                          stroke="currentColor"
                        >
                          <path
                            stroke-linecap="round"
                            stroke-linejoin="round"
                            stroke-width="2"
                            d="M19 9l-7 7-7-7"
                          />
                        </svg>
                      </button>
                    </div>
                    <div
                      class="mt-4 grid grid-cols-1 gap-4 sm:grid-cols-2 md:grid-cols-3 lg:grid-cols-4"
                    >
                      <template x-if="story.domains">
                        <template
                          x-for="(domain, index) in story.domains"
                          :key="index"
                        >
                          <button
                            x-show="index < visibleSources || showAllSources"
                            class="flex w-full flex-col items-start space-y-1 rounded-lg py-2 pl-2 text-left transition-colors hover:bg-gray-100 dark:hover:bg-gray-700"
                            @click.stop="$dispatch('open-source', { domain: domain, story: story })"
                            :aria-label="$t('sources.showArticlesFrom').replace('{source}', domain?.name || 'Unknown')"
                            :title="$t('sources.showArticlesFrom').replace('{source}', domain?.name || 'Unknown')"
                            tabindex="-1"
                            style="outline: none"
                          >
                            <div
                              class="flex w-full min-w-0 items-center space-x-2"
                            >
                              <img
                                :src="domain?.favicon || '%VITE_STATIC_PATH%/svg/placeholder.svg'"
                                :alt="domain?.name ? domain.name + ' Favicon' : 'Default Favicon'"
                                class="h-5 w-5 rounded-full"
                                loading="lazy"
                              />
                              <span
                                class="truncate text-sm font-semibold"
                                x-text="domain?.name || 'Unknown'"
                              ></span>
                            </div>
                            <span
                              class="ml-7 text-xs text-gray-500 dark:text-gray-400"
                              x-text="story?.articles ? $t('sources.articles').replace('{count}', story.articles.filter(a => a.domain === domain?.name).length) : $t('sources.articles').replace('{count}', 0)"
                            >
                            </span>
                          </button>
                        </template>
                      </template>
                    </div>
                  </section>

                  <section
                    x-show="story.user_action_items && story.user_action_items.length > 0 && $store.sections.settings.actionItems"
                    class="mt-6 rounded-lg bg-[#F1FAE8] p-4 dark:bg-[#2B411C]"
                    :class="'order-[' + $store.sections.order.indexOf('actionItems') + ']'"
                  >
                    <h3
                      class="mb-2 text-xl font-semibold text-gray-800 dark:text-gray-100"
                    >
                      <span x-text="$t('section.actionItems')"></span>
                    </h3>
                    <ul
                      class="mb-2 ml-4 list-disc space-y-2 text-gray-700 dark:text-gray-200"
                    >
                      <template
                        x-for="item in story.user_action_items"
                        :key="item"
                      >
                        <li x-text="item"></li>
                      </template>
                    </ul>
                  </section>

                  <section
                    x-show="story.did_you_know && $store.sections.settings.didYouKnow"
                    class="mt-6 rounded-lg bg-[#CED8FB] p-4 dark:bg-[#2A3B5E]"
                    :class="'order-[' + $store.sections.order.indexOf('didYouKnow') + ']'"
                  >
                    <h3
                      class="mb-2 text-xl font-semibold text-gray-800 dark:text-gray-100"
                    >
                      <span x-text="$t('article.didYouKnow')"></span>
                    </h3>
                    <p
                      class="text-gray-700 dark:text-gray-200"
                      x-text="story.did_you_know"
                    ></p>
                  </section>

                  <div
                    class="order-last mt-6 flex w-full items-center justify-center space-x-4 md:px-0"
                  >
                    <!--
                                        <button
                                            @click.stop="shareArticle(story)"
                                            :data-share-url="window.location.origin + window.location.pathname + '?article=' + currentCategory.toLowerCase() + '-' + story.cluster_number"
                                            class="w-full md:w-auto px-6 py-3 bg-white text-black border border-black font-semibold rounded-lg hover:bg-gray-100 focus:outline-none focus:ring-2 focus:ring-gray-400 focus:ring-opacity-75 transition-colors duration-200 ease-in-out"
                                        >
                                            Share this
                                        </button>
                                        -->
                    <button
                      @click.stop="closeStory(story, index)"
                      class="focus:ring-opacity-75 w-full rounded-lg bg-black px-6 py-3 font-semibold text-white transition-colors duration-200 ease-in-out hover:bg-gray-800 focus:ring-2 focus:ring-gray-400 focus:outline-none md:w-auto"
                    >
                      <span x-text="$t('article.closeStory')"></span>
                    </button>
                  </div>
                </section>
              </article>
            </template>
          </template>
          <div
            x-show="stories.length > 0 && currentCategory !== 'OnThisDay' && !stories.every(story => readStories[story.title])"
            class="mt-6 w-full text-center"
          >
            <button
              @click="markAllAsRead(); window.scrollTo({ top: 0, behavior: 'smooth' })"
              class="w-full rounded-lg bg-gray-100 px-6 py-3 text-gray-800 transition-colors duration-200 hover:bg-gray-200 md:w-auto dark:bg-gray-700 dark:text-gray-200 dark:hover:bg-gray-600"
            >
              <span x-text="$t('article.markAllAsRead')"></span>
            </button>
          </div>
        </div>
      </div>
    </main>

    <div
      x-show="showSourceOverlay"
      x-cloak
      @open-source.window="processSource($event)"
      @click.self="showSourceOverlay = false"
      class="fixed inset-0 z-[70] flex items-center justify-center bg-black/50 p-4 dark:bg-black/70"
    >
      <div
        class="max-h-[90vh] w-full max-w-2xl overflow-y-auto rounded-lg bg-white p-6 dark:bg-gray-800"
      >
        <header class="mb-4 flex items-center justify-between">
          <div class="flex items-center space-x-2">
            <img
              :src="currentSource?.favicon || '%VITE_STATIC_PATH%/svg/placeholder.svg'"
              :alt="currentSource?.name ? `${currentSource.name} favicon` : 'Generic favicon'"
              class="h-6 w-6"
            />
            <h3
              class="dark:text-dark-text text-xl font-bold"
              x-text="currentSource?.name || 'Unknown Source'"
            ></h3>
          </div>
          <button
            @click="showSourceOverlay = false"
            class="text-gray-500 hover:text-gray-700 dark:text-gray-400 dark:hover:text-gray-200"
          >
            <svg
              xmlns="http://www.w3.org/2000/svg"
              class="h-6 w-6"
              fill="none"
              viewBox="0 0 24 24"
              stroke="currentColor"
            >
              <path
                stroke-linecap="round"
                stroke-linejoin="round"
                stroke-width="2"
                d="M6 18L18 6M6 6l12 12"
              />
            </svg>
          </button>
        </header>
        <p
          class="mb-4 text-gray-600 dark:text-gray-400"
          x-text="$t('sources.articles').replace('{count}', (sourceArticles || []).length)"
        ></p>
        <div class="space-y-4">
          <template x-for="article in sourceArticles" :key="article.link">
            <article class="flex space-x-4">
              <img
                x-bind:src="article.image || '%VITE_STATIC_PATH%/svg/placeholder.svg'"
                alt="Article image"
                class="h-24 w-24 rounded object-cover"
              />
              <div>
                <a
                  :href="article.link"
                  target="_blank"
                  rel="noopener noreferrer"
                  class="hover:underline"
                  @click.stop
                >
                  <h4
                    class="dark:text-dark-text font-semibold"
                    x-text="article.title"
                  ></h4>
                </a>
                <p
                  class="text-sm text-gray-500 dark:text-gray-400"
                  x-text="new Date(article.date).toLocaleString()"
                ></p>
              </div>
            </article>
          </template>
        </div>

        <!-- Source Information -->
        <div class="mt-8 border-t border-gray-200 pt-4 dark:border-gray-700">
          <button
            @click="showSourceInfo = !showSourceInfo"
            class="flex w-full items-center justify-between rounded-lg p-2 text-left text-gray-800 hover:bg-gray-50 dark:text-gray-200 dark:hover:bg-gray-700"
          >
            <span class="font-semibold"
              ><span x-text="$t('source.info.title')"></span
            ></span>
            <svg
              class="h-5 w-5 transform transition-transform"
              :class="{'rotate-180': showSourceInfo}"
              xmlns="http://www.w3.org/2000/svg"
              viewBox="0 0 20 20"
              fill="currentColor"
            >
              <path
                fill-rule="evenodd"
                d="M5.293 7.293a1 1 0 011.414 0L10 10.586l3.293-3.293a1 1 0 111.414 1.414l-4 4a1 1 0 01-1.414 0l-4-4a1 1 0 010-1.414z"
                clip-rule="evenodd"
              />
            </svg>
          </button>

          <div
            x-show="showSourceInfo"
            x-transition:enter="transition ease-out duration-200"
            x-transition:enter-start="opacity-0 transform -translate-y-2"
            x-transition:enter-end="opacity-100 transform translate-y-0"
            class="mt-4"
          >
            <!-- Show this when media info exists -->
            <template x-if="mediaInfo">
              <div class="grid gap-6 md:grid-cols-3">
                <!-- Left Column -->
                <div class="col-span-1 space-y-4">
                  <!-- Country -->
                  <div class="flex items-center gap-2">
                    <svg
                      class="h-5 w-5 text-gray-500"
                      xmlns="http://www.w3.org/2000/svg"
                      fill="none"
                      viewBox="0 0 24 24"
                      stroke="currentColor"
                    >
                      <path
                        stroke-linecap="round"
                        stroke-linejoin="round"
                        stroke-width="2"
                        d="M3.055 11H5a2 2 0 012 2v1a2 2 0 002 2 2 2 0 012 2v2.945M8 3.935V5.5A2.5 2.5 0 0010.5 8h.5a2 2 0 012 2 2 2 0 104 0 2 2 0 012-2h1.064M15 20.488V18a2 2 0 012-2h3.064"
                      />
                    </svg>
                    <div>
                      <div class="font-medium text-gray-700 dark:text-gray-300">
                        <span x-text="$t('source.info.country')"></span>
                      </div>
                      <div
                        class="text-gray-600 dark:text-gray-400"
                        x-text="mediaInfo.country"
                      ></div>
                    </div>
                  </div>

                  <!-- Owner -->
                  <div class="flex items-center gap-2">
                    <svg
                      class="h-5 w-5 text-gray-500"
                      xmlns="http://www.w3.org/2000/svg"
                      fill="none"
                      viewBox="0 0 24 24"
                      stroke="currentColor"
                    >
                      <path
                        stroke-linecap="round"
                        stroke-linejoin="round"
                        stroke-width="2"
                        d="M12 4.354a4 4 0 110 5.292M15 21H3v-1a6 6 0 0112 0v1zm0 0h6v-1a6 6 0 00-9-5.197M13 7a4 4 0 11-8 0 4 4 0 018 0z"
                      />
                    </svg>
                    <div>
                      <div class="font-medium text-gray-700 dark:text-gray-300">
                        <span x-text="$t('source.info.owner')"></span>
                      </div>
                      <div
                        class="text-gray-600 dark:text-gray-400"
                        x-text="mediaInfo.owner || $t('source.info.notSpecified')"
                      ></div>
                    </div>
                  </div>

                  <!-- Organization -->
                  <div class="flex items-center gap-2">
                    <svg
                      class="h-5 w-5 text-gray-500"
                      xmlns="http://www.w3.org/2000/svg"
                      fill="none"
                      viewBox="0 0 24 24"
                      stroke="currentColor"
                    >
                      <path
                        stroke-linecap="round"
                        stroke-linejoin="round"
                        stroke-width="2"
                        d="M19 21V5a2 2 0 00-2-2H7a2 2 0 00-2 2v16m14 0h2m-2 0h-5m-9 0H3m2 0h5M9 7h1m-1 4h1m4-4h1m-1 4h1m-5 10v-5a1 1 0 011-1h2a1 1 0 011 1v5m-4 0h4"
                      />
                    </svg>
                    <div>
                      <div class="font-medium text-gray-700 dark:text-gray-300">
                        <span x-text="$t('source.info.organization')"></span>
                      </div>
                      <div
                        class="text-gray-600 dark:text-gray-400"
                        x-text="mediaInfo.organization"
                      ></div>
                    </div>
                  </div>

                  <!-- Media Classification -->
                  <div class="flex items-center gap-2">
                    <svg
                      class="h-5 w-5 text-gray-500"
                      xmlns="http://www.w3.org/2000/svg"
                      fill="none"
                      viewBox="0 0 24 24"
                      stroke="currentColor"
                    >
                      <path
                        stroke-linecap="round"
                        stroke-linejoin="round"
                        stroke-width="2"
                        d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"
                      />
                    </svg>
                    <div>
                      <div class="font-medium text-gray-700 dark:text-gray-300">
                        <span
                          x-text="$t('source.info.mediaClassification')"
                        ></span>
                      </div>
                      <div
                        class="text-gray-600 dark:text-gray-400"
                        x-text="mediaInfo.typology"
                      ></div>
                    </div>
                  </div>
                </div>

                <!-- Right Column -->
                <div class="col-span-2 space-y-4">
                  <!-- Description -->
                  <div
                    x-show="mediaInfo.description"
                    class="text-gray-700 dark:text-gray-300"
                  >
                    <h4 class="mb-2 font-medium">
                      <span x-text="$t('source.info.description')"></span>
                    </h4>
                    <p x-text="mediaInfo.description"></p>
                  </div>
                </div>
              </div>
            </template>

            <!-- Show this when no media info exists -->
            <template x-if="!mediaInfo">
              <div class="py-6 text-center">
                <h4
                  class="mb-2 text-lg font-semibold text-gray-800 dark:text-gray-200"
                >
                  <span x-text="$t('source.contribute.title')"></span>
                </h4>
                <p class="mb-4 text-gray-600 dark:text-gray-400">
                  <span x-text="$t('source.contribute.description')"></span>
                </p>
                <a
                  href="https://github.com/kagisearch/kite-public"
                  class="inline-flex items-center rounded-lg bg-blue-500 px-4 py-2 text-white transition-colors duration-200 hover:bg-blue-600"
                >
                  <svg
                    class="mr-2 h-5 w-5"
                    xmlns="http://www.w3.org/2000/svg"
                    viewBox="0 0 24 24"
                    fill="currentColor"
                  >
                    <path
                      d="M12 0c-6.626 0-12 5.373-12 12 0 5.302 3.438 9.8 8.207 11.387.599.111.793-.261.793-.577v-2.234c-3.338.726-4.033-1.416-4.033-1.416-.546-1.387-1.333-1.756-1.333-1.756-1.089-.745.083-.729.083-.729 1.205.084 1.839 1.237 1.839 1.237 1.07 1.834 2.807 1.304 3.492.997.107-.775.418-1.305.762-1.604-2.665-.305-5.467-1.334-5.467-5.931 0-1.311.469-2.381 1.236-3.221-.124-.303-.535-1.524.117-3.176 0 0 1.008-.322 3.301 1.23.957-.266 1.983-.399 3.003-.404 1.02.005 2.047.138 3.006.404 2.291-1.552 3.297-1.23 3.297-1.23.653 1.653.242 2.874.118 3.176.77.84 1.235 1.911 1.235 3.221 0 4.609-2.807 5.624-5.479 5.921.43.372.823 1.102.823 2.222v3.293c0 .319.192.694.801.576 4.765-1.589 8.199-6.086 8.199-11.386 0-6.627-5.373-12-12-12z"
                    />
                  </svg>
                  <span x-text="$t('source.contribute.button')"></span>
                </a>
              </div>
            </template>
          </div>
        </div>
      </div>
    </div>

    <!-- Settings Overlay -->
    <div
      x-data
      x-show="$store.settings.isOpen"
      x-cloak
      role="complementary"
      aria-label="Settings panel"
      class="fixed inset-0 z-[80] flex items-center justify-center bg-black/60 dark:bg-black/80"
      @click.self="$store.settings.close()"
      @keydown.escape.window="$store.settings.close()"
    >
      <div
        class="flex h-full w-full flex-col overflow-y-auto bg-white shadow-xl md:h-auto md:max-h-[90vh] md:max-w-[42rem] md:rounded-lg md:p-8 dark:bg-gray-800"
        @click.stop
        x-data="{ activeTab: 'general' }"
      >
        <header class="flex-shrink-0 bg-white p-4 md:p-0 dark:bg-gray-800">
          <div class="mb-1 flex justify-end">
            <button
              @click="$store.settings.close()"
              class="text-gray-500 transition-colors duration-200 hover:text-gray-700 dark:text-gray-400 dark:hover:text-gray-200"
            >
              <svg
                xmlns="http://www.w3.org/2000/svg"
                class="h-6 w-6"
                fill="none"
                viewBox="0 0 24 24"
                stroke="currentColor"
              >
                <path
                  stroke-linecap="round"
                  stroke-linejoin="round"
                  stroke-width="2"
                  d="M6 18L18 6M6 6l12 12"
                />
              </svg>
            </button>
          </div>
          <!-- Tabs -->
          <div class="flex border-b border-gray-200 dark:border-gray-700">
            <button
              @click="activeTab = 'general'"
              :class="{'border-blue-500 text-blue-600 dark:text-blue-400': activeTab === 'general',
                                    'border-transparent text-gray-500 dark:text-gray-400': activeTab !== 'general'}"
              class="border-b-2 px-4 py-2 text-sm font-medium"
            >
              <span x-text="$t('settings.tabs.general')"></span>
            </button>
            <button
              @click="activeTab = 'categories'"
              :class="{'border-blue-500 text-blue-600 dark:text-blue-400': activeTab === 'categories',
                                    'border-transparent text-gray-500 dark:text-gray-400': activeTab !== 'categories'}"
              class="border-b-2 px-4 py-2 text-sm font-medium"
            >
              <span x-text="$t('settings.tabs.categories')"></span>
            </button>
            <button
              @click="activeTab = 'sections'"
              :class="{'border-blue-500 text-blue-600 dark:text-blue-400': activeTab === 'sections',
                                    'border-transparent text-gray-500 dark:text-gray-400': activeTab !== 'sections'}"
              class="border-b-2 px-4 py-2 text-sm font-medium"
            >
              <span x-text="$t('settings.tabs.sections')"></span>
            </button>
            <button
              @click="activeTab = 'experimental'"
              :class="{'border-blue-500 text-blue-600 dark:text-blue-400': activeTab === 'experimental',
                                    'border-transparent text-gray-500 dark:text-gray-400': activeTab !== 'experimental'}"
              class="border-b-2 px-4 py-2 text-sm font-medium"
            >
              <span x-text="$t('settings.tabs.experimental')"></span>
            </button>
          </div>
        </header>
        <div class="mt-6 min-h-[400px] p-4 md:p-0">
          <!-- General Settings Tab -->
          <div x-show="activeTab === 'general'" class="space-y-6">
            <div class="flex flex-col space-y-2">
              <label
                for="theme-select"
                class="text-sm font-medium text-gray-700 dark:text-gray-300"
                ><span x-text="$t('settings.theme.label')"></span
              ></label>
              <div class="relative">
                <select
                  id="theme-select"
                  x-model="$store.theme.current"
                  @change="$store.theme.set($event.target.value)"
                  aria-label="Select theme preference"
                  class="block w-full appearance-none rounded-lg border border-gray-300 bg-white px-4 py-3 pr-8 leading-tight text-gray-700 focus:border-gray-500 focus:bg-white focus:outline-none dark:border-gray-600 dark:bg-gray-700 dark:text-gray-300"
                >
                  <option value="system">
                    <span x-text="$t('settings.theme.system')"></span>
                  </option>
                  <option value="light">
                    <span x-text="$t('settings.theme.light')"></span>
                  </option>
                  <option value="dark">
                    <span x-text="$t('settings.theme.dark')"></span>
                  </option>
                </select>
                <div
                  class="pointer-events-none absolute inset-y-0 right-0 flex items-center px-2 text-gray-700 dark:text-gray-300"
                >
                  <svg
                    class="h-4 w-4 fill-current"
                    xmlns="http://www.w3.org/2000/svg"
                    viewBox="0 0 20 20"
                  >
                    <path
                      d="M9.293 12.95l.707.707L15.657 8l-1.414-1.414L10 10.828 5.757 6.586 4.343 8z"
                    />
                  </svg>
                </div>
              </div>
            </div>
            <div class="flex flex-col space-y-2">
              <label
                for="language-select"
                class="text-sm font-medium text-gray-700 dark:text-gray-300"
                ><span x-text="$t('settings.language.label')"></span
              ></label>
              <div class="relative">
                <select
                  id="language-select"
                  x-model="$store.language.current"
                  @change="$store.language.set($event.target.value)"
                  aria-label="Select language"
                  class="block w-full appearance-none rounded-lg border border-gray-300 bg-white px-4 py-3 pr-8 leading-tight text-gray-700 focus:border-gray-500 focus:bg-white focus:outline-none dark:border-gray-600 dark:bg-gray-700 dark:text-gray-300"
                >
                  <option value="default">
                    <span x-text="$t('settings.language.default')"></span>
                  </option>
                  <option value="en">English (English)</option>
                  <option value="pt">Português (Portuguese)</option>
                  <option value="it">Italiano (Italian)</option>
                  <option value="fr">Français (French)</option>
                  <option value="es">Español (Spanish)</option>
                  <option value="de">Deutsch (German)</option>
                  <option value="zh-CN">中文 (Simplified Chinese)</option>
                  <option value="zh-TW">中文 (Traditional Chinese)</option>
                  <option value="ja">日本語 (Japanese)</option>
                  <option value="hi">हिन्दी (Hindi)</option>
                </select>
                <div
                  class="pointer-events-none absolute inset-y-0 right-0 flex items-center px-2 text-gray-700 dark:text-gray-300"
                >
                  <svg
                    class="h-4 w-4 fill-current"
                    xmlns="http://www.w3.org/2000/svg"
                    viewBox="0 0 20 20"
                  >
                    <path
                      d="M9.293 12.95l.707.707L15.657 8l-1.414-1.414L10 10.828 5.757 6.586 4.343 8z"
                    />
                  </svg>
                </div>
              </div>
            </div>

            <!-- Mobile-only category header position setting -->
            <div class="flex flex-col space-y-2 md:hidden">
              <label
                for="category-header-position"
                class="text-sm font-medium text-gray-700 dark:text-gray-300"
                ><span
                  x-text="$t('settings.categoryHeaderPosition.label')"
                ></span
              ></label>
              <div class="relative">
                <select
                  id="category-header-position"
                  x-model="$store.mobileUI.categoryHeaderPosition"
                  @change="$store.mobileUI.setCategoryHeaderPosition($event.target.value)"
                  aria-label="Select category header position"
                  class="block w-full appearance-none rounded-lg border border-gray-300 bg-white px-4 py-3 pr-8 leading-tight text-gray-700 focus:border-gray-500 focus:bg-white focus:outline-none dark:border-gray-600 dark:bg-gray-700 dark:text-gray-300"
                >
                  <option value="bottom">
                    <span
                      x-text="$t('settings.categoryHeaderPosition.bottom')"
                    ></span>
                  </option>
                  <option value="top">
                    <span
                      x-text="$t('settings.categoryHeaderPosition.top')"
                    ></span>
                  </option>
                </select>
                <div
                  class="pointer-events-none absolute inset-y-0 right-0 flex items-center px-2 text-gray-700 dark:text-gray-300"
                >
                  <svg
                    class="h-4 w-4 fill-current"
                    xmlns="http://www.w3.org/2000/svg"
                    viewBox="0 0 20 20"
                  >
                    <path
                      d="M9.293 12.95l.707.707L15.657 8l-1.414-1.414L10 10.828 5.757 6.586 4.343 8z"
                    />
                  </svg>
                </div>
              </div>
              <p class="mt-1 text-xs text-gray-500 dark:text-gray-400">
                <span
                  x-text="$t('settings.categoryHeaderPosition.description')"
                ></span>
              </p>
            </div>

            <div class="flex flex-col space-y-2">
              <label
                for="font-size-select"
                class="text-sm font-medium text-gray-700 dark:text-gray-300"
                ><span x-text="$t('settings.fontSize.label')"></span
              ></label>
              <div class="relative">
                <select
                  id="font-size-select"
                  x-model="$store.fontSize.current"
                  @change="$store.fontSize.set($event.target.value)"
                  aria-label="Select text size"
                  class="block w-full appearance-none rounded-lg border border-gray-300 bg-white px-4 py-3 pr-8 leading-tight text-gray-700 focus:border-gray-500 focus:bg-white focus:outline-none dark:border-gray-600 dark:bg-gray-700 dark:text-gray-300"
                >
                  <option value="small">
                    <span x-text="$t('settings.fontSize.small')"></span>
                  </option>
                  <option value="normal">
                    <span x-text="$t('settings.fontSize.normal')"></span>
                  </option>
                  <option value="large">
                    <span x-text="$t('settings.fontSize.large')"></span>
                  </option>
                </select>
                <div
                  class="pointer-events-none absolute inset-y-0 right-0 flex items-center px-2 text-gray-700 dark:text-gray-300"
                >
                  <svg
                    class="h-4 w-4 fill-current"
                    xmlns="http://www.w3.org/2000/svg"
                    viewBox="0 0 20 20"
                  >
                    <path
                      d="M9.293 12.95l.707.707L15.657 8l-1.414-1.414L10 10.828 5.757 6.586 4.343 8z"
                    />
                  </svg>
                </div>
              </div>
            </div>
            <div class="flex flex-col space-y-2">
              <label
                for="story-count-range"
                class="text-sm font-medium text-gray-700 dark:text-gray-300"
              >
                <span x-text="$t('settings.storyCount.label')"></span>
                <span x-text="$store.storyCount.current"></span>
              </label>
              <input
                id="story-count-range"
                type="range"
                min="3"
                max="12"
                x-model="$store.storyCount.current"
                @input="$store.storyCount.set($event.target.value); changeCategory()"
                @mousedown="lockScroll"
                @mouseup="unlockScroll"
                @touchstart="lockScroll"
                @touchend="unlockScroll"
                aria-label="Adjust number of stories shown"
                aria-valuemin="3"
                aria-valuemax="12"
                :aria-valuenow="$store.storyCount.current"
                class="h-2 w-full cursor-pointer appearance-none rounded-lg bg-gray-200 dark:bg-gray-700"
              />
            </div>

            <div class="flex flex-col space-y-2">
              <button
                @click="$store.settings.close(); showIntro = true; updateUrlWithArticleId('')"
                class="flex w-full items-center justify-center space-x-2 rounded-lg bg-gray-100 px-4 py-2 text-sm font-medium text-gray-800 transition-colors duration-200 hover:bg-gray-200 dark:bg-gray-700 dark:text-gray-200 dark:hover:bg-gray-600"
              >
                <img
                  :src="$store.theme.current === 'dark' ? '%VITE_STATIC_PATH%/svg/kite_dark.svg' : '%VITE_STATIC_PATH%/svg/kite.svg'"
                  alt="Kite icon"
                  class="h-4 w-4"
                />
                <span x-text="$t('settings.aboutKite.button')"></span>
              </button>
            </div>
          </div>
          <!-- Categories Tab -->
          <div x-show="activeTab === 'categories'" class="space-y-6">
            <div class="flex flex-col space-y-2">
              <p class="text-xs text-gray-500 dark:text-gray-400">
                <span x-text="$t('settings.categories.instructions')"></span>
              </p>

              <!-- Enabled categories container -->
              <div
                x-ref="enabledCategories"
                class="mb-4 flex flex-wrap gap-2"
              ></div>

              <!-- Separator -->
              <div
                class="my-4 border-t border-gray-200 dark:border-gray-700"
              ></div>

              <!-- Disabled categories container -->
              <div
                x-ref="disabledCategories"
                class="flex flex-wrap gap-2"
              ></div>

              <!-- Contribute link -->
              <div class="mt-4 flex justify-center">
                <a
                  href="https://github.com/kagisearch/kite-public"
                  class="text-sm text-blue-500 hover:text-blue-600 dark:text-blue-400 dark:hover:text-blue-300"
                >
                  <span x-text="$t('settings.categories.contribute')"></span>
                </a>
              </div>
            </div>
          </div>
          <!-- Sections Tab -->
          <div x-show="activeTab === 'sections'" class="space-y-6">
            <div
              class="flex flex-col space-y-4"
              x-ref="sectionsList"
              x-init="$nextTick(() => $store.sections.render())"
            ></div>
            <!-- Reset button -->
            <div class="mt-4 flex justify-center">
              <button
                @click="$store.sections.reset()"
                class="text-sm text-blue-500 hover:text-blue-600 dark:text-blue-400 dark:hover:text-blue-300"
              >
                <span x-text="$t('settings.sections.resetOrder')"></span>
              </button>
            </div>
          </div>

          <!-- Experimental Tab -->
          <div x-show="activeTab === 'experimental'" class="space-y-6">
            <p class="mb-6 text-sm text-gray-600 dark:text-gray-400">
              ⚠️
              <span
                class="ml-1"
                x-text="$t('settings.experimental.warning')"
              ></span>
            </p>

            <div
              class="rounded-lg border border-gray-200 p-4 dark:border-gray-700"
            >
              <div class="mb-2 flex items-center justify-between">
                <label
                  for="show-article-icons"
                  class="text-sm font-medium text-gray-700 dark:text-gray-300"
                >
                  <span
                    x-text="$t('settings.experimental.articleIcons.label')"
                  ></span>
                </label>
                <button
                  id="show-article-icons"
                  @click="$store.experimental.toggleArticleIcons(!$store.experimental.showArticleIcons)"
                  type="button"
                  class="relative inline-flex h-6 w-11 items-center rounded-full"
                  :class="$store.experimental.showArticleIcons ? 'bg-blue-600' : 'bg-gray-200 dark:bg-gray-700'"
                  role="switch"
                  :aria-checked="$store.experimental.showArticleIcons"
                >
                  <span class="sr-only"
                    ><span
                      x-text="$t('settings.experimental.articleIcons.label')"
                    ></span
                  ></span>
                  <span
                    class="inline-block h-4 w-4 transform rounded-full bg-white transition"
                    :class="$store.experimental.showArticleIcons ? 'translate-x-6' : 'translate-x-1'"
                  ></span>
                </button>
              </div>
              <p class="text-xs text-gray-500 dark:text-gray-400">
                <span
                  x-text="$t('settings.experimental.articleIcons.description')"
                ></span>
              </p>
            </div>

            <div
              class="rounded-lg border border-gray-200 p-4 dark:border-gray-700"
            >
              <div class="mb-2 flex items-center justify-between">
                <label
                  for="show-category-icons"
                  class="text-sm font-medium text-gray-700 dark:text-gray-300"
                >
                  <span
                    x-text="$t('settings.experimental.categoryIcons.label')"
                  ></span>
                </label>
                <button
                  id="show-category-icons"
                  @click="$store.experimental.toggleCategoryIcons(!$store.experimental.showCategoryIcons)"
                  type="button"
                  class="relative inline-flex h-6 w-11 items-center rounded-full"
                  :class="$store.experimental.showCategoryIcons ? 'bg-blue-600' : 'bg-gray-200 dark:bg-gray-700'"
                  role="switch"
                  :aria-checked="$store.experimental.showCategoryIcons"
                >
                  <span class="sr-only"
                    ><span
                      x-text="$t('settings.experimental.categoryIcons.label')"
                    ></span
                  ></span>
                  <span
                    class="inline-block h-4 w-4 transform rounded-full bg-white transition"
                    :class="$store.experimental.showCategoryIcons ? 'translate-x-6' : 'translate-x-1'"
                  ></span>
                </button>
              </div>
              <p class="text-xs text-gray-500 dark:text-gray-400">
                <span
                  x-text="$t('settings.experimental.categoryIcons.description')"
                ></span>
              </p>
            </div>

            <div
              class="rounded-lg border border-gray-200 p-4 md:hidden dark:border-gray-700"
            >
              <div class="mb-2 flex items-center justify-between">
                <label
                  for="disable-category-swipe"
                  class="text-sm font-medium text-gray-700 dark:text-gray-300"
                >
                  <span
                    x-text="$t('settings.experimental.disableCategorySwipe.label')"
                  ></span>
                </label>
                <button
                  id="disable-category-swipe"
                  @click="$store.experimental.toggleCategorySwipe(!$store.experimental.disableCategorySwipe)"
                  type="button"
                  class="relative inline-flex h-6 w-11 items-center rounded-full"
                  :class="$store.experimental.disableCategorySwipe ? 'bg-blue-600' : 'bg-gray-200 dark:bg-gray-700'"
                  role="switch"
                  :aria-checked="$store.experimental.disableCategorySwipe"
                >
                  <span class="sr-only"
                    ><span
                      x-text="$t('settings.experimental.disableCategorySwipe.label')"
                    ></span
                  ></span>
                  <span
                    class="inline-block h-4 w-4 transform rounded-full bg-white transition"
                    :class="$store.experimental.disableCategorySwipe ? 'translate-x-6' : 'translate-x-1'"
                  ></span>
                </button>
              </div>
              <p class="text-xs text-gray-500 dark:text-gray-400">
                <span
                  x-text="$t('settings.experimental.disableCategorySwipe.description')"
                ></span>
              </p>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Footer -->
    <footer class="mt-8 py-4">
      <div
        class="container mx-auto flex max-w-[732px] items-center justify-center space-x-6 px-4"
      >
        <a
          href="https://github.com/kagisearch/kite-public"
          target="_blank"
          title="Contribute to Kagi News"
          class="flex items-center space-x-2 text-gray-600 hover:text-gray-800 dark:text-gray-400 dark:hover:text-gray-200"
        >
          <svg
            class="h-5 w-5 text-gray-600 dark:text-gray-400"
            xmlns="http://www.w3.org/2000/svg"
            viewBox="0 0 24 24"
            fill="currentColor"
          >
            <path
              d="M12 0c-6.626 0-12 5.373-12 12 0 5.302 3.438 9.8 8.207 11.387.599.111.793-.261.793-.577v-2.234c-3.338.726-4.033-1.416-4.033-1.416-.546-1.387-1.333-1.756-1.333-1.756-1.089-.745.083-.729.083-.729 1.205.084 1.839 1.237 1.839 1.237 1.07 1.834 2.807 1.304 3.492.997.107-.775.418-1.305.762-1.604-2.665-.305-5.467-1.334-5.467-5.931 0-1.311.469-2.381 1.236-3.221-.124-.303-.535-1.524.117-3.176 0 0 1.008-.322 3.301 1.23.957-.266 1.983-.399 3.003-.404 1.02.005 2.047.138 3.006.404 2.291-1.552 3.297-1.23 3.297-1.23.653 1.653.242 2.874.118 3.176.77.84 1.235 1.911 1.235 3.221 0 4.609-2.807 5.624-5.479 5.921.43.372.823 1.102.823 2.222v3.293c0 .319.192.694.801.576 4.765-1.589 8.199-6.086 8.199-11.386 0-6.627-5.373-12-12-12z"
            />
          </svg>
          <span class="text-sm"
            ><span x-text="$t('footer.contribute')"></span
          ></span>
        </a>
        <a
          :href="currentCategory === 'OnThisDay' ? 
                        `https://en.wikipedia.org/w/api.php?action=featuredfeed&feed=onthisday&lang=${$store.language.current}` : 
                        `${currentCategory.toLowerCase()}.xml`"
          target="_blank"
          class="flex items-center space-x-2 text-gray-600 hover:text-gray-800 dark:text-gray-400 dark:hover:text-gray-200"
          title="RSS feed"
        >
          <img
            src="%VITE_STATIC_PATH%/svg/rss.svg"
            alt=""
            class="h-5 w-5 dark:invert"
            aria-hidden="true"
          />
          <span class="text-sm"
            ><span x-text="$t('footer.rssFeed')"></span
          ></span>
        </a>
      </div>
    </footer>
  </body>
</html>
